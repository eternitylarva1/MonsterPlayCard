# 基础架构和接口定义

## 概述

本文档定义了三个开发方向（Downfall卡牌导入、通用动作-意图转换、意图-卡牌转换）共同使用的基础架构和核心接口，确保系统间的兼容性和可扩展性。

## 核心架构

### 分层设计

```
┌─────────────────────────────────────────────────────────────┐
│                    应用层 (Application Layer)                │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            │
│  │ Downfall    │ │ Action-     │ │ Intent-     │            │
│  │ Importer    │ │ Intent      │ │ Card        │            │
│  │ System      │ │ Converter   │ │ Converter   │            │
│  └─────────────┘ └─────────────┘ └─────────────┘            │
├─────────────────────────────────────────────────────────────┤
│                    服务层 (Service Layer)                    │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            │
│  │ Card        │ │ Intent       │ │ Card        │            │
│  │ Registry    │ │ Analyzer     │ │ Generator   │            │
│  │ Service     │ │ Service      │ │ Service     │            │
│  └─────────────┘ └─────────────┘ └─────────────┘            │
├─────────────────────────────────────────────────────────────┤
│                    核心层 (Core Layer)                       │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            │
│  │ ICard       │ │ IIntent      │ │ IAction     │            │
│  │ Importer    │ │ Converter    │ │ Analyzer    │            │
│  └─────────────┘ └─────────────┘ └─────────────┘            │
├─────────────────────────────────────────────────────────────┤
│                    事件层 (Event Layer)                      │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            │
│  │ Event       │ │ Event       │ │ Event       │            │
│  │ Bus         │ │ Dispatcher  │ │ Listener    │            │
│  └─────────────┘ └─────────────┘ └─────────────┘            │
├─────────────────────────────────────────────────────────────┤
│                    数据层 (Data Layer)                       │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            │
│  │ Card        │ │ Intent       │ │ Action       │            │
│  │ Metadata    │ │ Metadata     │ │ Metadata     │            │
│  └─────────────┘ └─────────────┘ └─────────────┘            │
└─────────────────────────────────────────────────────────────┘
```

## 核心接口定义

### 1. 卡牌导入接口

```java
package EveryMonsterPlayCard.core.interfaces;

import com.megacrit.cardcrawl.cards.AbstractCard;
import java.util.List;
import java.util.Map;

/**
 * 卡牌导入器接口
 * 负责从外部模组导入卡牌数据
 */
public interface ICardImporter {
    /**
     * 导入指定模组的所有卡牌
     * @param modId 模组ID
     * @return 导入的卡牌列表
     */
    List<AbstractCard> importCards(String modId);
    
    /**
     * 检查模组是否兼容
     * @param modId 模组ID
     * @return 是否兼容
     */
    boolean isCompatible(String modId);
    
    /**
     * 获取卡牌元数据
     * @param cardId 卡牌ID
     * @return 卡牌元数据
     */
    CardMetadata getMetadata(String cardId);
    
    /**
     * 获取支持的模组列表
     * @return 支持的模组ID列表
     */
    List<String> getSupportedMods();
    
    /**
     * 验证卡牌数据完整性
     * @param card 卡牌对象
     * @return 验证结果
     */
    ValidationResult validateCard(AbstractCard card);
}

/**
 * 卡牌元数据
 */
public class CardMetadata {
    public String cardId;
    public String name;
    public String description;
    public String modId;
    public String rarity;
    public String type;
    public String color;
    public int cost;
    public Map<String, Object> customProperties;
    
    // 构造函数、getter、setter方法
}

/**
 * 验证结果
 */
public class ValidationResult {
    public boolean isValid;
    public List<String> errors;
    public List<String> warnings;
    
    // 构造函数、getter、setter方法
}
```

### 2. 意图转换接口

```java
package EveryMonsterPlayCard.core.interfaces;

import com.megacrit.cardcrawl.actions.AbstractGameAction;
import com.megacrit.cardcrawl.monsters.AbstractMonster;
import java.util.List;

/**
 * 动作到意图转换器接口
 * 负责将游戏动作转换为怪物意图
 */
public interface IActionToIntentConverter {
    /**
     * 将单个动作转换为意图
     * @param action 游戏动作
     * @return 怪物意图
     */
    MonsterIntent convertAction(AbstractGameAction action);
    
    /**
     * 分解复杂动作为多个意图
     * @param action 复杂动作
     * @return 意图列表
     */
    List<MonsterIntent> decomposeComplexAction(AbstractGameAction action);
    
    /**
     * 分类意图类型
     * @param action 游戏动作
     * @return 意图类型
     */
    IntentType classifyIntent(AbstractGameAction action);
    
    /**
     * 计算意图强度
     * @param action 游戏动作
     * @return 意图强度值
     */
    int calculateIntentStrength(AbstractGameAction action);
    
    /**
     * 验证转换结果
     * @param action 原始动作
     * @param intent 转换后的意图
     * @return 验证结果
     */
    boolean validateConversion(AbstractGameAction action, MonsterIntent intent);
}

/**
 * 怪物意图数据结构
 */
public class MonsterIntent {
    public IntentType type;
    public int amount;
    public AbstractMonster source;
    public AbstractMonster target;
    public List<AbstractGameAction> componentActions;
    public IntentMetadata metadata;
    
    // 构造函数、getter、setter方法
}

/**
 * 意图类型枚举
 */
public enum IntentType {
    ATTACK, DEFEND, BUFF, DEBUFF, STRONG, ESCAPE, UNKNOWN
}

/**
 * 意图元数据
 */
public class IntentMetadata {
    public String intentId;
    public String description;
    public int priority;
    public Map<String, Object> properties;
    
    // 构造函数、getter、setter方法
}
```

### 3. 意图到卡牌转换接口

```java
package EveryMonsterPlayCard.core.interfaces;

import com.megacrit.cardcrawl.cards.AbstractCard;
import com.megacrit.cardcrawl.monsters.AbstractMonster;
import java.util.List;

/**
 * 意图到卡牌转换器接口
 * 负责将怪物意图转换为卡牌
 */
public interface IIntentToCardConverter {
    /**
     * 将意图转换为卡牌
     * @param intent 怪物意图
     * @return 生成的卡牌
     */
    AbstractCard convertIntent(MonsterIntent intent);
    
    /**
     * 推断卡牌属性
     * @param intent 怪物意图
     * @return 卡牌属性
     */
    CardAttributes inferAttributes(MonsterIntent intent);
    
    /**
     * 模拟卡牌效果
     * @param card 卡牌对象
     * @return 模拟的动作列表
     */
    List<AbstractGameAction> simulateEffects(AbstractCard card);
    
    /**
     * 优化卡牌平衡性
     * @param card 原始卡牌
     * @return 优化后的卡牌
     */
    AbstractCard balanceCard(AbstractCard card);
    
    /**
     * 验证生成的卡牌
     * @param card 卡牌对象
     * @param originalIntent 原始意图
     * @return 验证结果
     */
    boolean validateCard(AbstractCard card, MonsterIntent originalIntent);
}

/**
 * 卡牌属性
 */
public class CardAttributes {
    public String name;
    public String description;
    public int cost;
    public CardType type;
    public CardColor color;
    public CardRarity rarity;
    public CardTarget target;
    public int damage;
    public int block;
    public int magicNumber;
    public List<String> tags;
    
    // 构造函数、getter、setter方法
}
```

## 事件系统

### 事件总线接口

```java
package EveryMonsterPlayCard.core.events;

import java.util.List;
import java.util.concurrent.ConcurrentHashMap;

/**
 * 事件总线接口
 * 负责系统间的事件通信
 */
public interface IEventBus {
    /**
     * 注册事件监听器
     * @param eventType 事件类型
     * @param listener 监听器
     */
    <T extends IEvent> void registerListener(Class<T> eventType, IEventListener<T> listener);
    
    /**
     * 取消注册事件监听器
     * @param eventType 事件类型
     * @param listener 监听器
     */
    <T extends IEvent> void unregisterListener(Class<T> eventType, IEventListener<T> listener);
    
    /**
     * 发布事件
     * @param event 事件对象
     */
    void publishEvent(IEvent event);
    
    /**
     * 获取指定类型的监听器列表
     * @param eventType 事件类型
     * @return 监听器列表
     */
    <T extends IEvent> List<IEventListener<T>> getListeners(Class<T> eventType);
}

/**
 * 事件监听器接口
 */
public interface IEventListener<T extends IEvent> {
    /**
     * 处理事件
     * @param event 事件对象
     */
    void handleEvent(T event);
    
    /**
     * 获取监听器优先级
     * @return 优先级值（数值越小优先级越高）
     */
    default int getPriority() {
        return 0;
    }
}

/**
 * 基础事件接口
 */
public interface IEvent {
    /**
     * 获取事件时间戳
     * @return 时间戳
     */
    long getTimestamp();
    
    /**
     * 获取事件源
     * @return 事件源对象
     */
    Object getSource();
    
    /**
     * 获取事件类型
     * @return 事件类型
     */
    String getEventType();
}
```

### 具体事件定义

```java
package EveryMonsterPlayCard.core.events;

/**
 * 卡牌导入事件
 */
public class CardImportEvent implements IEvent {
    private final long timestamp;
    private final Object source;
    private final String modId;
    private final List<AbstractCard> importedCards;
    private final boolean success;
    private final String errorMessage;
    
    // 构造函数、getter方法
}

/**
 * 意图转换事件
 */
public class IntentConversionEvent implements IEvent {
    private final long timestamp;
    private final Object source;
    private final AbstractGameAction originalAction;
    private final MonsterIntent convertedIntent;
    private final boolean success;
    private final String errorMessage;
    
    // 构造函数、getter方法
}

/**
 * 卡牌生成事件
 */
public class CardGenerationEvent implements IEvent {
    private final long timestamp;
    private final Object source;
    private final MonsterIntent originalIntent;
    private final AbstractCard generatedCard;
    private final boolean success;
    private final String errorMessage;
    
    // 构造函数、getter方法
}
```

## 配置系统

### 配置管理接口

```java
package EveryMonsterPlayCard.core.config;

import java.util.Map;
import java.util.Set;

/**
 * 配置管理器接口
 */
public interface IConfigManager {
    /**
     * 获取配置值
     * @param key 配置键
     * @param defaultValue 默认值
     * @return 配置值
     */
    <T> T getConfig(String key, T defaultValue);
    
    /**
     * 设置配置值
     * @param key 配置键
     * @param value 配置值
     */
    void setConfig(String key, Object value);
    
    /**
     * 获取所有配置键
     * @return 配置键集合
     */
    Set<String> getAllKeys();
    
    /**
     * 检查配置是否存在
     * @param key 配置键
     * @return 是否存在
     */
    boolean hasConfig(String key);
    
    /**
     * 重新加载配置
     */
    void reloadConfig();
    
    /**
     * 保存配置
     */
    void saveConfig();
    
    /**
     * 注册配置变更监听器
     * @param listener 监听器
     */
    void registerConfigChangeListener(IConfigChangeListener listener);
}

/**
 * 配置变更监听器接口
 */
public interface IConfigChangeListener {
    /**
     * 配置变更时的回调
     * @param key 配置键
     * @param oldValue 旧值
     * @param newValue 新值
     */
    void onConfigChanged(String key, Object oldValue, Object newValue);
}
```

### 配置文件结构

```json
{
  "downfall": {
    "enabled": true,
    "autoImport": true,
    "balanceAdjustments": true,
    "supportedVersions": ["1.0.0", "1.1.0"]
  },
  "intentConversion": {
    "enabled": true,
    "complexActionDecomposition": true,
    "intentStrengthCalculation": "advanced",
    "validationEnabled": true
  },
  "cardGeneration": {
    "enabled": true,
    "attributeInference": "smart",
    "balanceOptimization": true,
    "effectSimulation": true
  },
  "integration": {
    "eventLogging": true,
    "performanceMonitoring": true,
    "errorReporting": true
  }
}
```

## 扩展点机制

### 插件接口

```java
package EveryMonsterPlayCard.core.plugins;

/**
 * 插件接口
 */
public interface IPlugin {
    /**
     * 获取插件ID
     * @return 插件ID
     */
    String getPluginId();
    
    /**
     * 获取插件名称
     * @return 插件名称
     */
    String getPluginName();
    
    /**
     * 获取插件版本
     * @return 插件版本
     */
    String getVersion();
    
    /**
     * 初始化插件
     */
    void initialize();
    
    /**
     * 启用插件
     */
    void enable();
    
    /**
     * 禁用插件
     */
    void disable();
    
    /**
     * 检查插件是否已启用
     * @return 是否已启用
     */
    boolean isEnabled();
    
    /**
     * 获取插件依赖
     * @return 依赖列表
     */
    List<String> getDependencies();
}

/**
 * 插件管理器接口
 */
public interface IPluginManager {
    /**
     * 注册插件
     * @param plugin 插件对象
     */
    void registerPlugin(IPlugin plugin);
    
    /**
     * 取消注册插件
     * @param pluginId 插件ID
     */
    void unregisterPlugin(String pluginId);
    
    /**
     * 获取插件
     * @param pluginId 插件ID
     * @return 插件对象
     */
    IPlugin getPlugin(String pluginId);
    
    /**
     * 获取所有已注册的插件
     * @return 插件列表
     */
    List<IPlugin> getAllPlugins();
    
    /**
     * 启用插件
     * @param pluginId 插件ID
     */
    void enablePlugin(String pluginId);
    
    /**
     * 禁用插件
     * @param pluginId 插件ID
     */
    void disablePlugin(String pluginId);
    
    /**
     * 检查插件依赖
     * @param plugin 插件对象
     * @return 依赖检查结果
     */
    DependencyCheckResult checkDependencies(IPlugin plugin);
}
```

## 错误处理

### 异常定义

```java
package EveryMonsterPlayCard.core.exceptions;

/**
 * 基础异常类
 */
public class MonsterPlayCardException extends RuntimeException {
    private final String errorCode;
    private final Object[] parameters;
    
    public MonsterPlayCardException(String errorCode, String message) {
        super(message);
        this.errorCode = errorCode;
        this.parameters = new Object[0];
    }
    
    public MonsterPlayCardException(String errorCode, String message, Throwable cause) {
        super(message, cause);
        this.errorCode = errorCode;
        this.parameters = new Object[0];
    }
    
    public MonsterPlayCardException(String errorCode, String message, Object... parameters) {
        super(message);
        this.errorCode = errorCode;
        this.parameters = parameters;
    }
    
    // getter方法
}

/**
 * 卡牌导入异常
 */
public class CardImportException extends MonsterPlayCardException {
    public CardImportException(String errorCode, String message) {
        super(errorCode, message);
    }
    
    public CardImportException(String errorCode, String message, Throwable cause) {
        super(errorCode, message, cause);
    }
}

/**
 * 意图转换异常
 */
public class IntentConversionException extends MonsterPlayCardException {
    public IntentConversionException(String errorCode, String message) {
        super(errorCode, message);
    }
    
    public IntentConversionException(String errorCode, String message, Throwable cause) {
        super(errorCode, message, cause);
    }
}

/**
 * 卡牌生成异常
 */
public class CardGenerationException extends MonsterPlayCardException {
    public CardGenerationException(String errorCode, String message) {
        super(errorCode, message);
    }
    
    public CardGenerationException(String errorCode, String message, Throwable cause) {
        super(errorCode, message, cause);
    }
}
```

## 日志系统

### 日志接口

```java
package EveryMonsterPlayCard.core.logging;

/**
 * 日志接口
 */
public interface ILogger {
    /**
     * 记录调试信息
     * @param message 消息
     */
    void debug(String message);
    
    /**
     * 记录调试信息
     * @param message 消息模板
     * @param args 参数
     */
    void debug(String message, Object... args);
    
    /**
     * 记录信息
     * @param message 消息
     */
    void info(String message);
    
    /**
     * 记录信息
     * @param message 消息模板
     * @param args 参数
     */
    void info(String message, Object... args);
    
    /**
     * 记录警告
     * @param message 消息
     */
    void warn(String message);
    
    /**
     * 记录警告
     * @param message 消息模板
     * @param args 参数
     */
    void warn(String message, Object... args);
    
    /**
     * 记录错误
     * @param message 消息
     */
    void error(String message);
    
    /**
     * 记录错误
     * @param message 消息模板
     * @param args 参数
     */
    void error(String message, Object... args);
    
    /**
     * 记录错误
     * @param message 消息
     * @param throwable 异常
     */
    void error(String message, Throwable throwable);
    
    /**
     * 记录错误
     * @param message 消息模板
     * @param throwable 异常
     * @param args 参数
     */
    void error(String message, Throwable throwable, Object... args);
}
```

## 总结

这套基础架构和接口定义为三个开发方向提供了统一的开发基础，确保了系统间的兼容性和可扩展性。通过清晰的接口定义、事件系统、配置机制和错误处理，各个开发团队可以独立工作而不产生冲突，同时保证最终系统的整体质量和稳定性。