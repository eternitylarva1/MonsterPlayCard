# 怪物卡牌系统综合修复报告

## 修复概述

本次修复主要解决了怪物卡牌系统中的三个核心问题：
1. 怪物攻击牌受玩家力量影响的问题
2. Power触发钩子调用不正确的问题
3. 塞牌Action使用反射的问题

## 问题分析与修复

### 1. 怪物攻击牌受玩家力量影响的问题

#### 问题描述
怪物的攻击牌在计算伤害时，错误地使用了目标怪物（玩家）的Power来修改伤害，而不是使用卡牌拥有者怪物的Power。

#### 根本原因
在 `AbstractMonsterCard.java` 的 `calculateCardDamage` 方法中，代码错误地调用了：
```java
// 错误：使用目标怪物的Power
for (AbstractPower p : targetMonster.powers) {
    p.atDamageGive(tmp, damageTypeForTurn);
}
```

#### 修复方案
修改为使用卡牌拥有者怪物的Power：
```java
// 正确：使用拥有者怪物的Power
for (AbstractPower p : owningMonster.powers) {
    p.atDamageGive(tmp, damageTypeForTurn);
}
```

#### 修复文件
- `src/main/java/EveryMonsterPlayCard/cards/monster/AbstractMonsterCard.java`

### 2. Power触发钩子调用不正确的问题

#### 问题描述
Power的触发钩子（如 `onUseCard`、`onExhaust`、`onCardDraw`）没有在正确的位置被调用，导致怪物Power无法正常响应卡牌事件。

#### 根本原因
1. 在 `executeMonsterCardAction` 中直接调用Power钩子，而不是在对应的Action中调用
2. 触发了错误的钩子（如触发玩家的抽牌钩子而不是怪物的）
3. 没有为怪物创建专门的Action类

#### 修复方案
创建了三个怪物版本的Action类，确保Power钩子在正确的位置被触发：

1. **MonsterUseCardAction** - 处理卡牌使用时的Power钩子
2. **MonsterExhaustCardAction** - 处理卡牌消耗时的Power钩子  
3. **MonsterDrawCardAction** - 处理卡牌抽取时的Power钩子

#### 修复文件
- `src/main/java/EveryMonsterPlayCard/monstercards/actions/MonsterUseCardAction.java` (新建)
- `src/main/java/EveryMonsterPlayCard/monstercards/actions/MonsterExhaustCardAction.java` (新建)
- `src/main/java/EveryMonsterPlayCard/monstercards/actions/MonsterDrawCardAction.java` (新建)
- `src/main/java/EveryMonsterPlayCard/monstercards/actions/executeMonsterCardAction.java` (修改)

### 3. 塞牌Action使用反射的问题

#### 问题描述
`MonsterMakeTempCardInHandAction` 使用反射来访问 `MonsterCardPlayer` 的私有字段，违反了项目规范。

#### 根本原因
直接使用反射访问私有字段 `monsterHand`，而不是使用公共方法。

#### 修复方案
1. 在 `MonsterCardPlayer` 中添加公共方法：
   - `addCardToHand(AbstractCard card)` - 添加卡牌到手牌
   - `refreshDisplayedCardsPublic()` - 刷新显示的卡牌

2. 修改 `MonsterMakeTempCardInHandAction` 使用这些公共方法而不是反射

#### 修复文件
- `src/main/java/EveryMonsterPlayCard/monstercards/MonsterCardPlayer.java` (添加公共方法)
- `src/main/java/EveryMonsterPlayCard/monstercards/actions/MonsterMakeTempCardInHandAction.java` (修改)

## 技术细节

### Power钩子触发顺序
修复后的Power钩子触发顺序如下：

1. **卡牌使用时** (`MonsterUseCardAction`)
   - 触发拥有者怪物的 `onUseCard` 钩子
   - 触发玩家的 `onUseCard` 钩子
   - 如果目标不是玩家，触发目标怪物的 `onUseCard` 钩子

2. **卡牌消耗时** (`MonsterExhaustCardAction`)
   - 触发拥有者怪物的 `onExhaust` 钩子
   - 触发玩家的 `onExhaust` 钩子

3. **卡牌抽取时** (`MonsterDrawCardAction`)
   - 触发拥有者怪物的 `onCardDraw` 钩子
   - 触发玩家的 `onCardDraw` 钩子

### 伤害计算流程
修复后的伤害计算流程：

1. 基础伤害计算
2. 应用拥有者怪物的 `atDamageGive` 修改
3. 应用目标怪物的 `atDamageReceive` 修改
4. 应用目标怪物的 `atDamageFinalReceive` 修改

## 测试验证

### 构建测试
项目成功通过Maven构建，无编译错误：
```
[INFO] BUILD SUCCESS
[INFO] Total time: 6.786 s
```

### 功能测试建议
建议进行以下测试以验证修复效果：

1. **伤害计算测试**
   - 怪物使用攻击牌时，伤害不受玩家力量影响
   - 怪物力量增加时，攻击牌伤害正确增加

2. **Power钩子测试**
   - 怪物Power在卡牌使用时正确触发
   - 怪物Power在卡牌消耗时正确触发
   - 怪物Power在卡牌抽取时正确触发

3. **塞牌功能测试**
   - 卡牌正确添加到怪物手牌
   - 手牌显示正确更新
   - 无反射相关错误

## 代码质量改进

### 遵循的设计原则
1. **单一职责原则** - 每个Action类只负责一种特定的卡牌操作
2. **开闭原则** - 通过扩展而不是修改现有代码来添加新功能
3. **依赖倒置原则** - 依赖抽象而不是具体实现

### 避免的反模式
1. **不使用反射** - 在同一模块内避免使用反射访问私有字段
2. **正确的钩子位置** - Power钩子在对应的Action中触发，而不是在执行器中
3. **类型安全** - 确保参数类型匹配，避免类型转换错误

## 总结

本次修复解决了怪物卡牌系统中的核心问题，确保了：
1. 怪物攻击牌的伤害计算正确，不受玩家力量影响
2. Power钩子在正确的位置被触发，怪物Power能正常工作
3. 代码质量提升，避免了反射等不良实践

修复后的系统更加稳定、可维护，并且符合Slay the Spire Mod开发的最佳实践。